<!DOCTYPE html>
<!-- main HTML file for web2py database diagram [last modified 31 Jan 2013 by Paolo Caruccio] -->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 9]><html class="ie ie9 ie-lte9 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="{{=T.accepted_language or 'en'}}"> <!--<![endif]-->
    <head>
        <meta charset="utf-8" />
        <title>{{=response.title or request.application}}</title>
        <meta name="application-name" content="{{=request.application}}" />
        <meta name="google-site-verification" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="{{=URL('static', 'favicon.ico')}}" type="image/x-icon"/>
        <link href="//fonts.googleapis.com/css?family=Jura:400,600" rel="stylesheet" type="text/css">
        <link rel="stylesheet" type="text/css" media="all" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/smoothness/jquery-ui.css"/>
        <link rel="stylesheet" type="text/css" media="all" href="{{=URL('static', 'db_diagram/db_diagram.css')}}"/>
        <link rel="stylesheet" type="text/css" media="print" href="{{=URL('static', 'db_diagram/db_diagram_print.css')}}"/>
        <style>
        .dbdia-canvas{position:relative;}
        .dbdia-node{position:absolute;left:-9999px;top:0;float:left;z-index:10;}
        </style>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
        <script src="{{=URL('static', 'db_diagram/jquery.jsPlumb-1.3.16-all-min.js')}}"></script>
        <script src="{{=URL('static', 'db_diagram/jquery.dbdiagram.js')}}"></script>
    </head>

    <body>
        <div id="preload"><h1>Loading...</h1></div>
        <div id="page" style="display:none;"> 
            <header>
                <div class="dbdia-title-box">
                    <h1 class="dbdia-title">
                        <small>{{=T("diagram of")}}</small>
                        <b>{{=response.title.replace('_', ' ') or request.application.replace('_', ' ')}}</b>
                    </h1>
                    <span class="dbdia-credit">generated by <a href="http://www.web2py.com" target="_blank">web2py</a>&trade;&nbsp;</span>
                </div><div id="dbdia-menu-wrapper">{{=MENU(response.menu, _class='dbdia-menu')}}</div>
            </header>

            <section>{{if databases:}}
                <div id="dbdia-container">
                    <div class="dbdia-canvas">
                        {{for node, content in nodes.items():}}
                        <div id="{{=node}}" class="dbdia-node {{=content['css_class'] if 'css_class' in content else ''}}"><span>{{=node}}<em></em></span></div>
                        <div id="{{=node}}-detail" class="popup-dialog">{{=A(T('add'), _class='addUrl', _style='display:none', _href=URL('insert', args=['db', node]))}}{{=A("%s.%s" % ('db', node), _class='selUrl', _style='display:none', _href=URL('select', args=['db'], vars=dict(query='db.%s.%s>0'%(node, content['primary_key']))))}}
                            <ul class="table-fields">{{for field in content['table_fields']:}}{{cssc=''}}{{fstatus=''}}{{if not field.writable:}}{{cssc += 'nw'}}{{fstatus += 'unwritable '}}{{pass}}{{if not field.readable:}}{{cssc += 'nr'}}{{fstatus += 'unreadable '}}{{pass}}
                                <li id="{{=node}}-{{=field.name}}"> <a title="{{=T(fstatus)}}" class="{{=cssc}}"></a>{{if field.name == content['primary_key']:}}
                                    <i class="{{='primary'}}">{{='Pk'}}</i>{{elif field.type.startswith('reference') or field.type.startswith('list:reference'):}}{{referenced_table = field.type.split()[1].split('.')[0]}}{{if not node.startswith('auth_'):}}{{if not referenced_table.startswith('auth_'):}}
                                    <i class="{{='foreign'}}">{{='Fk'}}</i>{{else:}}
                                    <i class="{{='hidden-reference'}}">{{='<'}}</i>{{pass}}{{else:}}
                                    <i class="{{='foreign'}}">{{='Fk'}}</i>{{pass}}{{else:}}
                                    <i class="">&nbsp;</i>{{pass}}{{=field.name}} <small>{{=field.type}}&nbsp;{{=field.length if field.type == 'string' else ''}}</small>
                                </li>{{pass}}
                                <li class="table_info_title">{{=T('Table Info')}}</li>
                                <li><a class="info_key" title="{{=T('does table_archive exist in db?')}}">{{=T('Has archive')}}:</a>&nbsp;{{='yes' if content.get('has_archive') else 'no'}}</li>
                                <li><a class="info_key" title="{{=T('nr of rows inserted')}}">{{=T('Rows')}}:</a>&nbsp;{{=db(db[node][content['primary_key']]>0).count()}}</li>
                                <li><a class="info_key" title="{{=T('columns with index')}}">{{=T('Indexed columns')}}:</a>&nbsp;{{=content['indexed_columns']}}</li>
                                <li><a class="info_key" title="{{=T('affected tables when a row is deleted from this table')}}">{{=T('Cascade')}}:</a>&nbsp;{{=", ".join(content['cascade_chain']) if content['cascade_chain'] else '-'}}</li>
                            </ul>
                        </div>
                        {{pass}}
                    </div>
                </div>{{else:}}
                <div id="dbia-alert" class="ui-widget">
                    <div class="ui-state-error ui-corner-all"> 
                        <p>
                            <span class="ui-icon ui-icon-alert"></span>
                            <b>{{=T('Alert')}}:</b> {{=T("No database named 'db' in this application")}}
                        </p>
                    </div>
                </div>{{pass}}
            </section>
        </div>

        <script>
            function showTableDetail(el) {
                var o = jQuery('#'+el);
                var d = jQuery('#'+el+'-detail');
                var bgColor = o.css('backgroundColor');
                var addUrl = jQuery('#'+el+'-detail > a.addUrl').attr("href");
                var selUrl = jQuery('#'+el+'-detail > a.selUrl').attr("href");
                var dlgButtons = {
                    "{{=T('New record')}}": function () {
                        window.open(addUrl);
                    },
                    "{{=T('Rows in table')}}": function () {
                        window.open(selUrl);
                    }
                };
                var options = {
                    title: '<i class="triangle" style="border-color:'+bgColor+' transparent transparent transparent"></i>'+el,
                    width: 226,
                    minWidth: 226,
                    minHeight: 160,
                    position: { my: "left top", at: "left bottom", of: o },
                    buttons: dlgButtons
                };
                d.dialog('option', options);
                d.dialog('open');
            };

            function plumbNodes() {
                var color = "gray";
                jsPlumb.Defaults.Container = jQuery("div.dbdia-canvas");
                jsPlumb.importDefaults({
                    Connector : [ "Bezier", { curviness:50 } ],
                    DragOptions : { cursor: "pointer", zIndex:2000 },
                    PaintStyle : { strokeStyle:color, lineWidth:1 },
                    EndpointStyle : { radius:1, fillStyle:color },
                    HoverPaintStyle : { strokeStyle:"#ec9f2e" },
                    EndpointHoverStyle : { fillStyle:"#ec9f2e" },
                    Anchors : [[ "Perimeter", { shape:"rectangle" } ],
                               [ "Perimeter", { shape:"rectangle" } ]]
                });

                var arrowCommon = { foldback:0.5, fillStyle:color, width:8 },
                    overlays = [[ "Arrow", { location:0.5 }, arrowCommon ]];{{for node, content in nodes.items():}}{{if content['linked_nodes']:}}
                var s = jQuery('#{{=node}}'),{{for lt in content['linked_nodes']:}}
                    t = jQuery('#{{=lt[0]}}');
                jsPlumb.connect({source:s, target:t, overlays:overlays, detachable:false});{{pass}}{{pass}}{{pass}}

                jsPlumb.draggable(jsPlumb.getSelector(".dbdia-node"), {containment:jQuery(".dbdia-canvas")});
                
                jQuery(".dbdia-node").click(function(){
                    if ( jQuery(this).is('.ui-draggable-dragging') ) {
                          return;
                    }
                    showTableDetail(jQuery(this).attr('id'));
                });
            };

            function drawLayout() {
                var g = new Graph();{{n = 0}}{{for node, content in nodes.items():}}
                var s = jQuery('#{{=node}}');{{if content['linked_nodes']:}}{{for lt in content['linked_nodes']:}}
                var t = jQuery('#{{=lt[0]}}');
                g.addEdge(s, t);{{pass}}{{else:}}
                {{if content['css_class'].endswith('strong-entity'):}}
                s.css({'left':'0', 'top':'{{=n}}'+'px'});{{n += 28}}{{pass}}{{pass}}{{pass}}
                var layouter = new Graph.Layout.Spring(g);
                layouter.layout();
                
                var vpw = document.documentElement.clientWidth,
                    vph = document.documentElement.clientHeight;
                jQuery('.dbdia-canvas').css({'width':vpw-33, 'height':vph-131});
                var renderer = new Graph.Renderer.Basic(jQuery('.dbdia-canvas'), g);
                renderer.draw();
            };

            function doIt(callback){
                drawLayout();
                callback();
            };
            
            jQuery("#preload").show();

            jQuery(document).ready(function(){
                
                jQuery("#preload").hide();
                jQuery("#page").show();
                
                doIt(function(){
                    plumbNodes();
                });
                
                jQuery('.popup-dialog').dialog ({
                    autoOpen: false
                });
            });
        </script>
    </body>
</html>